{% extends 'base.html' %}
{% load static %}
{% block title %} Chat Maps {% endblock %}

    {% block style %}
<link href="http://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css" rel="Stylesheet"
        type="text/css" />
    <style>
        .fa, .far, .fas {
            font-family: "Font Awesome 5 Free" !important;
        }
        .chat-map-columns .title-col-box{
        padding: 5px;

        }
        .map-container-box{
            border: 1px solid;
            padding: 15px;
        }
        .map-container-box.border-gray{
        border-color: #949494;
        }

        .map-container-box.border-orange{
        border-color: #ff8a00;
        }
        .map-container-box .map-title{
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
        }
        p.h4-p{
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 0;
        }
        p.block-text{
        font-size: 14px;
        color: #949494;
        margin-bottom: 0;
        }
        .ques-link, .ques-link:hover{
        font-weight: 600;
        color: #ff8a00;
        margin-top: 15px;
        }
        .ml-bot-icon{
        max-width: 120px;
        }
        .ml-smile-icon{
        max-width: 35px;
        }
        .pos-rel{
        position: relative;
        }
        .active-chat-map{
        border-color: #ff8a00 !important;
        box-shadow: 0 0 2px 0px #ff8a00;
        }
        a.create-new-map-class{
        color: #000;
        }
        a.create-new-map-class:hover{
        text-decoration: none;
        }

        .map-actions .col-sm-4{
        padding: 0 1px;

        }

        .map-actions .col-sm-4 a{
        padding: 5px 2px 0 5px;

        }
        .map-actions .col-sm-4 button{
        padding: 0 2px;
        }
        #testChatMapModal .modal-dialog{
        max-width: 350px;
        }
        #testChatMapModal .modal-body{
        background-color: #f9f9fa;
        }
        #testChatMapModal .modal-body .messages{
        height: 300px;
        overflow-y: scroll;
        outline: none;
        margin-bottom: 20px;
        }

        #testChatMapModal .modal-body .messages #chatID{
        list-style-type: none;
        padding-left: 0;
        }
        #testChatMapModal .modal-body .messages #chatID li{
        padding: 10px 15px;
        border-radius: 25px;
        max-width: 200px;
        min-width: 60px;

        }
        #testChatMapModal .modal-body .messages #chatID li:last-of-type{
        margin-bottom: 10px;
        }

        #testChatMapModal .modal-body .messages #chatID li.sent{
        background-color: {{ company_qry.color }};
        color: #fff;
        border-bottom-right-radius: 0;
        clear: both;
        float: right;
        margin-top: 10px;
        margin-right: 10px;
        }
        #testChatMapModal .modal-body .messages #chatID li.replies{
        background-color: #e5e5e5;
        color: #000;
        border-bottom-left-radius: 0;
        clear: both;
        float: left;

        }
        #testChatMapModal .modal-body .messages #chatID li.replies:not(:first-of-type){
        margin-top: 10px;
        }
        .message-input .wrap input {
        font-family: lato;
        float: left;
        border: none;
        width: calc(100% - 60px);
        padding: 11px 32px 10px 8px;
        font-size: 0.8em;
        color: #32465a;
        }
        .message-input button.submit {
        width: 50px;
        height: 42px;
        float: right;
        border-radius: 0;
        min-width: 10px;
        background-color: {{ company_qry.color }} !important;
        border-color: {{ company_qry.color }} !important;
        color: #fff;
        }
        .sent-span, .sent-span:hover {
            padding: 10px 15px;
            margin-right: 5px;
            background: #fff !important;
            color: #000;
            cursor: pointer;
            border-radius: 25px;
            margin-top: 10px;
            border-color: {{ company_qry.color }};
            width: 100%;
            font-size: 14px;
        }
        .typing-icon{
            float:left;
            min-width:250px;
            clear: both;
        }
        .typing-icon img{
            width: 70px;
        }
        .reply-div .reply-url{
        word-break: break-word;
        }
        .p-end-map{
        font-size: 14px;
        color: red;
        }
        .border-gray .button-submit-blank{
        border-color: #949494;
        }
        .open-datepicker{
        cursor: pointer;
        }
        #book-appointment-div{
            clear: both;
            text-align: center;
            background-color: #fff;
            border-radius: 6px;
            padding: 10px;
            border: 1px solid {{ company_qry.color }};
        }
        .reply-div .carousel{
        margin-top: 10px;
        }
        .carousel-control-next, .carousel-control-prev{
        height: 35px;
        background: transparent;
        opacity: 1;
        border-radius: 6px;
        width: 10px;
        top: calc(50% - 17px);
        }
        .carousel-control-prev{
        left: -13px;
        }
        .carousel-control-next{
        right: -13px;
        }
        .sent-span, .sent-span:hover {
        border-color: {{ company.color }}
        }
        #chatID li.sent {
        background-color: {{ company.color }} !important;
        }

    </style>
    {% endblock %}


{% block content %}
<div class="page-heading">
    <h2 class="float-left">Chatmap list: {{ company.name }}</h2>
    <a href="{% url 'bot_list' %}" class="btn button-submit float-right">Back</a>
</div>
<div class="clearfix"></div>
<div class="row chat-map-columns">
    <div class="col-sm-6 title-col-box">
        <div class="map-container-box border-orange">
            <div class="row">
                <div class="col-sm-8">
                    <p class="h4-p">ML Learning Chatbot</p>
                    <p class="block-text">Teach your bot to answer repetitive queries and be available to 24 * 7 for your client.</p>
                    <p class="block-text">More conversation with your clients make your bot more intelligent.</p>
                    <a class="btn button-submit-blank ques-link"
                       href="{% url 'notify' id=company.id bot_name=company.name %}">
                        Teach Your Bot
                    </a>
                </div>
                <div class="col-sm-4">
                    <div class="ml-auto mr-auto">
                        <img src="{% static 'page-icons/chatbot.png' %}" class="ml-bot-icon" >
                    </div>
                    <div class="ml-auto mr-auto pos-rel" style="left:70px;">
                        <img src="{% static 'page-icons/smile.png' %}" class="ml-smile-icon" >
                    </div>
                    <div class="ml-auto mr-auto pos-rel" style="left:85px;bottom: 15px;">
                        <img src="{% static 'page-icons/smile.png' %}" class="ml-smile-icon" >
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-3 title-col-box">
        <a href="{% url 'create_chat_map' id=company.id bot_name=company.name %}"
           class="create-new-map-class">
            <div class="map-container-box border-gray">
                <div class="map-title">Create New Chatmap</div>
            </div>
        </a>
    </div>
    {% for title in chat_title %}
    <div class="col-sm-3 title-col-box">
        <div {% if title.active %} class="map-container-box active-chat-map" {% else %} class="map-container-box border-gray" {% endif %}>
            <div class="map-icon"></div>
            <div class="map-title">{{ title.title }}</div>
            <div class="map-description"></div>
            <div class="map-actions row">
                {% if title.question_titles.count != 0 %}
                <div class="col-sm-4">

                <button type="button" class="btn button-submit-blank test-bot w-100" data-toggle="modal"
                        data-chat="{{ title.pk }}" data-title="{{ title.title }}" data-lang="{{ title.company.language }}"
                        data-color="{{ title.company.color }}" data-target="#testChatMapModal">
                    Test Map
                </button>

                </div>
                {% endif %}
                <div class="col-sm-4">
                <a href="{% url 'edit_chat_map' id=title.pk chat_title=title.title %}" class="btn button-submit-blank w-100">Edit</a>
                </div>
                {% if title.question_titles.count != 0 %}
                <div class="col-sm-4">

                <a href="{% url 'change_chat_map_status' id=title.pk %}" class="btn button-submit-blank w-100">
                   {% if title.active %} Deactivate {% else %} Activate {% endif %}
                </a>
                </div>
                    {% endif %}
                    <div class="col-sm-4">
                <a href="{% url 'delete_chat_title' id=title.pk %}" class="btn button-submit-blank w-100">
                   Delete
                </a>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<!--- Modal ---->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Delete Confirmation</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          Are you sure you want to delete <span id="chat-title-modal"></span> chat.
      </div>
      <div class="modal-footer">

        <button class="btn button-submit" id="sub-button">Continue</button>
      </div>
    </div>
  </div>
</div>

<!------ Test Chat Map Modal  ------->
<div class="modal fade" id="testChatMapModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="testChatMapModalLabel"></h5>
      </div>
      <div class="modal-body pb-0">
          <input id="datepicker" style="display: none;">
          <div class="messages">
              <p class="text-center mb-0 mt-5 p-insta">Click on <b>Start</b> to start the chat.</p>
			<div id="message-list">
			<ul id="chatID">

			</ul>
            <div id="book-appointment-div" style="display: none;">
				Appointment will be booked after getting user confirmation.
			</div>
			</div>

		</div>
		<div class="message-input">
			<div class="wrap">
			<input  type="text" class="input-box hidden-element" id="chat-new-plot-message-input"
						  data-button="chat-new-plot-message-submit" placeholder="Type your response here...." />
			<button class="submit" id="chat-new-plot-message-submit" data-title-pk="">
                  <i class="fa fa-paper-plane" aria-hidden="true"></i>
             </button>
			</div>
		</div>
      </div>
      <div class="modal-footer">
          <p class="text-center mb-0 p-end-map end-chat-div hidden-element">Chat map ended.</p>
        <button class="btn button-submit-blank start-chat-button" id="start-chat-button" data-pk="" >Start</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block script %}
<script src='https://unpkg.com/jquery.nicescroll@3.7.6/jquery.nicescroll.js'></script>
<script type="text/javascript" src="http://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="text/javascript" src="http://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script>
$(document).ready( function () {

<!---- Stop slid carousel ----->

$(".carousel").carousel({
interval: false
})

<!---- Slot Book ----->

$(document).on("click", ".slot-list", function(){
var $this = $(this)
ClickOnSlot($this)
});

<!------ Open calender -------->
$(document).on("click", ".open-datepicker", function(){
$('#datepicker').datepicker('show');
});
$("#datepicker").datepicker({

    dateFormat: 'yy-mm-dd',
    minDate: '1d',
    changeMonth: true,
    changeYear: true,
    onSelect: function(dateText){
    	var date = $(this).val()
    	var page_url = "{% url 'get_slot_list' %}"
    	var language = '{{ chat_title.0.company.language }}'
    	var typing_icon = "<img src='{% static 'bot/images/typing_icon.gif' %}'>"
          AfterDateSelect(date, page_url, language, typing_icon)
        }
});

    <!---- Click on service provider ----->
    $(document).on("click", ".provider-list", function(){
        $this = $(this)
         calender_line = "Click on calender icon to open calender."
         var typing_icon = "<img src='{% static 'bot/images/typing_icon.gif' %}'>"
         ClickedServiceProvider($this, calender_line, typing_icon)
    })

    <!---- Open Provider list ----->

    $(document).on("click", ".book-appointment", function(){
        var title = $(this).html()
        var pk = $(this).attr("data-pk")
        page_url = '{% url "choose_service_provider" %}'
        var language = '{{ chat_title.0.company.language }}'
        var typing_icon = "<img src='{% static 'bot/images/typing_icon.gif' %}'>"
        BookAppointment(title, page_url, language, pk, typing_icon)
    });

    <!----- Submit on Enter -------->
		$(".wrap input").keyup(function(e){
			if (e.keyCode === 13) {
				var button = $(this).attr("data-button")
				$("#"+button).click();
			}
		})

    <!---- Text response ----->
    $(".wrap #chat-new-plot-message-submit").click(function(){
        debugger;
        var pk = $(this).attr("data-title-pk")
        var selected = $(".wrap .input-box").val()
        var child = $(".replies:last").find(".reply-div").attr("data-child")
        var number = $(".replies:last").find(".reply-div").attr("data-number")
        view_url = "{% url 'start_chat' %}"
        var lang = $(".start-chat-button").attr("data-lang")
        $("#chatID").append("<li class='sent'>"+selected+"</li>")
        AppendMessageBox();
        $(".wrap #chat-new-plot-message-input").addClass("hidden-element").val("")
        $(".wrap #chat-new-plot-message-submit").addClass("hidden-element")
        setTimeout(function(){
            $("#chatID").append("<li class='typing-icon'><img src='{% static 'bot/images/typing_icon.gif' %}'></li>");
        AppendMessageBox();
        }, 500)
        setTimeout(function(){
        NextQuestionAjax(view_url, pk, lang, "next", child, number, "false", "false" )
        }, 1500);

    })

    <!---- Option Answer response ---->
    $(document).on('click', '.select-option', function(){

    var selected = $(this).html()
    var child = $(".replies:last").find(".reply-div").attr("data-child")
    var number = $(".replies:last").find(".reply-div").attr("data-number")
    var option_child = $(this).attr("data-child")
    var option_number = $(this).attr("data-number")
    var lang = $(".start-chat-button").attr("data-lang")
    var pk = $(this).attr("data-title-pk")
    view_url = "{% url 'start_chat' %}"
    $(".sent-span").remove();

    $("#chatID").append("<li class='sent'>"+selected+"</li>")
        AppendMessageBox()
    setTimeout(function(){
        $("#chatID").append("<li class='typing-icon'><img src='{% static 'bot/images/typing_icon.gif' %}'></li>");
        AppendMessageBox();
    }, 500)
    setTimeout(function(){
        NextQuestionAjax(view_url, pk, lang, "next", child, number, option_child, option_number )
    }, 1500)
    });

    <!----- Start Chat ------->
    $(".start-chat-button").click(function(){
        var pk = $(this).attr("data-pk")
        var title = $(this).attr("data-title")
        var lang = $(this).attr("data-lang")
        $(this).addClass("hidden-element");
        $(".p-insta").addClass("hidden-element")
        view_url = "{% url 'start_chat' %}"
        NextQuestionAjax(view_url, pk, lang, "start", "child", "number", false, false )
     });

    <!----- On Chat Demo Modal Show ------->
    $('#testChatMapModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget)
      var title = button.data('title')
      var pk = button.data('chat')
      var lang = button.data('lang')
      var color = button.data('color')

      var modal = $(this)
      modal.find('#testChatMapModalLabel').html(title)
      modal.find("#start-chat-button").attr("data-pk", pk)
      modal.find("#start-chat-button").attr("data-title", title)
      modal.find("#start-chat-button").attr("data-lang", lang)
      $(".wrap #chat-new-plot-message-submit").attr("data-title-pk", pk)
      modal.find("#input-submit").css({"background-color": color, "border-color": color})
      modal.find("ul#chatID").empty();
      $(".p-insta").removeClass("hidden-element")
      $(".start-chat-button").removeClass("hidden-element");
      $(".wrap #chat-new-plot-message-input").addClass("hidden-element")
      $(".wrap #chat-new-plot-message-submit").addClass("hidden-element")
      $(".p-end-map").addClass("hidden-element")
      $("#book-appointment-div").hide();
      $("li.sent").css("background-color", color)
      $("#book-appointment-div").css("border", "1px solid"+color)
      $(".sent-span, .sent-span:hover").css("border-color", color)
      $(".message-input button.submit").css({"background-color": color, "border-color": color})
    })

  <!------- Delete <ch></ch>at ------->
    $('#deleteModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget)
      var title = button.data('title')
      var pk = button.data('pk')

      var modal = $(this)
      modal.find('#chat-title-modal').html("<b>"+title+"</b>")
      modal.find("#sub-button").attr("data-pk", pk)
    })

    $("#sub-button").click(function(){
    var pk = $(this).attr("data-pk");
    window.location.href = '/delete_chat_title/'+pk

    });

    <!--&lt;!&ndash; Nice scroll -&ndash;&gt;-->
    <!--$(".messages").niceScroll({-->
      <!--cursorcolor:"{{ company.color }}",-->
      <!--cursorwidth:"10px",-->
      <!--autohidemode: scroll,-->
      <!--enableobserver: true,-->
    <!--});-->

});
</script>
{% endblock %}
